#! /usr/bin/env ruby
$:.unshift File.expand_path("../../lib", File.realpath(__FILE__))

require "optparse"

options = {
  host: '0.0.0.0',
  port: 9292,
}

cli_parser = OptionParser.new do |opt|
  opt.banner = "Usage: sinapse [OPTIONS]"
  opt.separator ""
  opt.separator "Options:"

  opt.on("-h HOST", "--host HOST", "defaults to 0.0.0.0") do |host|
    options[:host] = host
  end

  opt.on("-p PORT", "--port PORT", "defaults to 9292") do |port|
    options[:port] = port.to_i
  end

  #opt.on("-P PATH", "--pid PATH", "path to PID file") do |path|
  #  options[:pid] = path
  #end
end

cli_parser.parse!

require 'bundler/setup'
require 'sinapse'
require 'celluloid/autostart'

begin
  server = nil

  trap("INT") do
    server.quit if server
    exit
  end

  server = Sinapse::Server.run(options[:host], options[:port], spy: true)
end
